# Конфигурация тегов (tags.json)

## Назначение

Файл `tags.json` содержит полное описание всех тегов (битов и регистров) вашего контроллера Modbus TCP. При запуске приложение автоматически загружает этот файл и использует теги для опроса контроллера.

## Карта адресов Modbus Coils (биты контроллера)

### Входные биты (Digital Inputs)
- **Диапазон**: X0 - X1023
- **Адреса Modbus**: 0 - 1023
- **Назначение**: Дискретные входы контроллера
- **Формула**: X[n] = 0 + n
- **Пример**: X0 → адрес 0, X10 → адрес 10, X1023 → адрес 1023

### Выходные биты (Digital Outputs)
- **Диапазон**: Y0 - Y1023  
- **Адреса Modbus**: 1536 - 2559
- **Назначение**: Дискретные выходы контроллера
- **Формула**: Y[n] = 1536 + n
- **Пример**: Y0 → адрес 1536, Y5 → адрес 1541, Y1023 → адрес 2559

### Вспомогательные реле (Auxiliary Relay)
- **Диапазон**: M0 - M12287
- **Адреса Modbus**: 3072 - 15359
- **Назначение**: Внутренние флаги/реле контроллера
- **Формула**: M[n] = 3072 + n
- **Пример**: M0 → адрес 3072, M100 → адрес 3172, M12287 → адрес 15359

### Таймеры (Timers)
- **Диапазон**: T0 - T1023
- **Адреса Modbus**: 15360 - 16383
- **Назначение**: Биты состояния таймеров (ON/OFF)
- **Формула**: T[n] = 15360 + n
- **Пример**: T0 → адрес 15360, T50 → адрес 15410, T1023 → адрес 16383

### Счётчики (Counters)
- **Диапазон**: C0 - C255
- **Адреса Modbus**: 16384 - 16639
- **Назначение**: Биты состояния счётчиков (ON/OFF)
- **Формула**: C[n] = 16384 + n
- **Пример**: C0 → адрес 16384, C100 → адрес 16484, C255 → адрес 16639

### Системные биты (System Status Bits)
- **Диапазон**: SM0 - SM215
- **Адреса Modbus**: 16896 - 17111
- **Назначение**: Системные флаги контроллера (статус, ошибки)
- **Формула**: SM[n] = 16896 + n
- **Пример**: SM0 → адрес 16896, SM1 → адрес 16897, SM215 → адрес 17111

### Шаговые реле (Step Relay)
- **Диапазон**: S0 - S2047
- **Адреса Modbus**: 28672 - 30719
- **Назначение**: Биты для последовательного управления (state machine)
- **Формула**: S[n] = 28672 + n
- **Пример**: S0 → адрес 28672, S100 → адрес 28772, S2047 → адрес 30719

## Расположение файла

- **При разработке**: `Scada.Client/tags.json`
- **После сборки**: `Scada.Client/bin/Debug/net8.0/tags.json` (копируется автоматически)
- **В релизе**: рядом с exe-файлом приложения

## Структура файла

```json
{
  "Tags": [
    {
      "Enabled": true,
      "Name": "X0",
      "Address": 0,
      "Register": 2,
      "Type": 5,
      "WordOrder": 0,
      "Scale": 1.0,
      "Offset": 0.0
    }
  ],
  "Groups": {
    "DigitalInputs": ["X0", "X1", ...],
    "DigitalOutputs": ["Y0", "Y1", ...],
    ...
  }
}
```

## Описание полей тега

### Обязательные поля

- **`Enabled`** (bool): Включён ли тег для опроса
  - `true` - тег будет опрашиваться автоматически
  - `false` - тег игнорируется

- **`Name`** (string): Уникальное имя тега
  - Примеры: `"X0"`, `"Y1"`, `"M5"`, `"AI_Temperature"`
  - Используется для связи с UI элементами

- **`Address`** (ushort): Modbus адрес тега (0-65535)
  - Для битов (coils): от 0 до 30719 (в вашем контроллере)
  - Для регистров: от 0 до 18308 (в вашем контроллере)

- **`Register`** (int): Тип регистра Modbus
  - `0` = Holding Register (чтение/запись, 40001-49999)
  - `1` = Input Register (только чтение, 30001-39999)
  - `2` = Coils (биты, чтение/запись, 00001-09999)

- **`Type`** (int): Тип данных
  - `0` = UInt16 (беззнаковое 16-бит)
  - `1` = Int16 (знаковое 16-бит)
  - `2` = UInt32 (беззнаковое 32-бит, 2 регистра)
  - `3` = Int32 (знаковое 32-бит, 2 регистра)
  - `4` = Float32 (с плавающей точкой, 2 регистра)
  - `5` = Bool (логическое, для coils)

### Опциональные поля

- **`WordOrder`** (int): Порядок слов для многорегистровых типов
  - `0` = HighLow (старшее слово первое, по умолчанию)
  - `1` = LowHigh (младшее слово первое)

- **`Scale`** (double): Коэффициент масштабирования
  - Значение = (RawValue × Scale) + Offset
  - По умолчанию: `1.0`

- **`Offset`** (double): Смещение значения
  - Применяется после масштабирования
  - По умолчанию: `0.0`

## Примеры использования

### Дискретные входы (X0-X7)

```json
{
  "Enabled": true,
  "Name": "X0",
  "Address": 0,
  "Register": 2,
  "Type": 5,
  "WordOrder": 0,
  "Scale": 1.0,
  "Offset": 0.0
}
```

**Пояснение**:
- Coil с адресом 0
- Тип Bool
- Используется для InputBitsIndicator

### Дискретные выходы (Y0-Y3)

```json
{
  "Enabled": true,
  "Name": "Y0",
  "Address": 512,
  "Register": 2,
  "Type": 5,
  "WordOrder": 0,
  "Scale": 1.0,
  "Offset": 0.0
}
```

**Пояснение**:
- Coil с адресом 512
- Используется для управления кнопками CoilButton/ImageButton

### Аналоговый вход с масштабированием

```json
{
  "Enabled": true,
  "Name": "AI_Temperature",
  "Address": 100,
  "Register": 0,
  "Type": 1,
  "WordOrder": 0,
  "Scale": 0.1,
  "Offset": -50.0
}
```

**Пояснение**:
- Holding Register 100
- Тип Int16
- Масштабирование: Temp = (RawValue × 0.1) - 50
- Пример: RawValue=550 → (550 × 0.1) - 50 = **5.0°C**

### Float32 (датчик давления)

```json
{
  "Enabled": true,
  "Name": "AI_Pressure",
  "Address": 101,
  "Register": 0,
  "Type": 4,
  "WordOrder": 0,
  "Scale": 1.0,
  "Offset": 0.0
}
```

**Пояснение**:
- Занимает 2 регистра: 101 и 102
- Формат IEEE 754 Float32
- Прямое чтение без масштабирования

## Группировка тегов

Раздел `Groups` используется для организации тегов по категориям:

```json
"Groups": {
  "DigitalInputs": ["X0", "X1", "X2", ...],
  "DigitalOutputs": ["Y0", "Y1", "Y2", ...],
  "InternalRelay": ["M0", "M1", "M2", ...],
  "Timers": ["T0", "T1", ...],
  "Counters": ["C0", "C1", ...],
  "SystemStatus": ["SM0", "SM1", ...],
  "StepRelay": ["S0", "S1", ...],
  "AnalogInputs": ["AI_Temperature", "AI_Pressure", ...],
  "AnalogOutputs": ["AO_Speed", "AO_Position"]
}
```

**Применение**:
- Фильтрация тегов в ComboBox по типу
- Группировка в настройках
- Удобная навигация

## Сводная таблица адресов

| Тип | Префикс | Диапазон | Начальный адрес | Конечный адрес | Количество |
|-----|---------|----------|-----------------|----------------|------------|
| Входы | X | X0 - X1023 | 0 | 1023 | 1024 |
| Выходы | Y | Y0 - Y1023 | 1536 | 2559 | 1024 |
| Вспом. реле | M | M0 - M12287 | 3072 | 15359 | 12288 |
| Таймеры | T | T0 - T1023 | 15360 | 16383 | 1024 |
| Счётчики | C | C0 - C255 | 16384 | 16639 | 256 |
| Систем. биты | SM | SM0 - SM215 | 16896 | 17111 | 216 |
| Шаговые реле | S | S0 - S2047 | 28672 | 30719 | 2048 |

**Всего доступно битов**: 30720 (от 0 до 30719)

## Настройка под ваш контроллер

1. **Узнайте карту адресов вашего контроллера**
   - Из документации ПЛК
   - Из конфигурации SCADA/HMI
   - С помощью утилит Modbus (Modbus Poll, ModScan)

2. **Отредактируйте tags.json**
   - Замените примеры адресов на реальные
   - Добавьте все необходимые теги
   - Установите правильные Scale/Offset для аналоговых сигналов

3. **Пример структуры адресов**:
   ```
   X0-X7    (входы)  → coils 0-7
   Y0-Y3    (выходы) → coils 512-515
   M0-M15   (флаги)  → coils 1024-1039
   AI0-AI3  (аналог) → holding registers 100-103
   AO0-AO1  (аналог) → holding registers 200-201
   ```

4. **Перезапустите приложение**
   - Теги загружаются автоматически при старте
   - Проверьте Debug вывод: `"Loaded N tags from tags.json"`

## Отладка

Если теги не загружаются:

1. Проверьте синтаксис JSON (без комментариев!)
2. Убедитесь, что файл находится рядом с exe
3. Смотрите Debug вывод в Visual Studio Output Window
4. Проверьте права доступа к файлу

## Резервное копирование

**Рекомендация**: Сохраните копию `tags.json` с описанием вашего контроллера!
