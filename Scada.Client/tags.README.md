# Tags Configuration - Работа с файлом tags.json

## Описание

Файл `tags.json` содержит **полную карту адресов PLC** (35421 тег) для приложения SCADA.

При первом запуске приложения автоматически загружаются **первые 20 тегов каждого типа** в `settings.json`.

## Структура файла tags.json

```json
{
  "description": "Complete PLC address mapping",
  "totalTags": 35421,
  "tags": [...]
}
```

## Типы тегов

### Дискретные биты (Bool)

| Префикс | Диапазон | Адреса | Тип регистра | Доступ | Описание |
|---------|----------|--------|--------------|--------|----------|
| **X** | X0 - X1023 | 0 - 1023 | Input | ReadOnly | Входные биты |
| **Y** | Y0 - Y1023 | 1536 - 2559 | Coils | ReadWrite | Выходные биты |
| **M** | M0 - M12287 | 3072 - 15359 | Coils | ReadWrite | Вспомогательное реле |
| **T** | T0 - T1023 | 15360 - 16383 | Coils | ReadWrite | Таймеры (биты) |
| **C** | C0 - C255 | 16384 - 16639 | Coils | ReadWrite | Счетчики (биты) |
| **SM** | SM0 - SM215 | 16896 - 17111 | Coils | ReadWrite | Системные биты |
| **S** | S0 - S2047 | 28672 - 30719 | Coils | ReadWrite | Пошаговое реле |

### Регистры (Int16/UInt16/Int32)

| Префикс | Диапазон | Адреса | Тип регистра | Тип данных | Описание |
|---------|----------|--------|--------------|------------|----------|
| **AI** | AI0 - AI255 | 0 - 255 | Input | UInt16 | Аналоговые входы |
| **AQ** | AQ0 - AQ255 | 256 - 511 | Holding | UInt16 | Аналоговые выходы |
| **V** | V0 - V14847 | 512 - 15359 | Holding | Int16 | Регистры данных |
| **TV** | TV0 - TV1023 | 15360 - 16383 | Holding | UInt16 | Значения таймеров |
| **CV** | CV0 - CV47 | 16384 - 16431 | Holding | UInt16 | Значения счетчиков 16-бит |
| **CV** | CV48 - CV255 | 16432 - 16639 | Holding | Int32 | Значения счетчиков 32-бит |
| **SV** | SV0 - SV900 | 17408 - 18308 | Holding | UInt16 | Системные регистры |

## Автоматическая загрузка при первом запуске

При запуске приложения:

1. **Проверяется** `%AppData%\Scada.Client\settings.json`
2. Если файл **отсутствует** или **теги пустые**:
   - Загружаются **первые 20 тегов** каждого типа из `tags.json`
   - Теги сохраняются в `settings.json`
3. В settings.json будут загружены:
   - X0 - X19 (20 входных битов)
   - Y0 - Y19 (20 выходных битов)
   - M0 - M19 (20 вспомогательных реле)
   - T0 - T19 (20 битов таймеров)
   - C0 - C19 (20 битов счетчиков)
   - SM0 - SM19 (20 системных битов)
   - S0 - S19 (20 пошаговых реле)
   - AI0 - AI19 (20 аналоговых входов)
   - AQ0 - AQ19 (20 аналоговых выходов)
   - V0 - V19 (20 регистров данных)
   - TV0 - TV19 (20 значений таймеров)
   - CV0 - CV19 (20 значений счетчиков)
   - SV0 - SV19 (20 системных регистров)

**Итого**: ~260 тегов вместо 35421

## Использование в приложении

### Выбор тега в контекстном меню кнопки

1. Правый клик по кнопке (CoilButton, ImageButton, CoilMomentaryButton)
2. В ComboBox появятся доступные теги нужного типа:
   - **CoilButton / CoilMomentaryButton**: M0-M19, Y0-Y19, SM0-SM19
   - **ImageButton**: X0-X19, Y0-Y19, SM0-SM19
3. Выберите тег из списка
4. Адрес кнопки обновится автоматически

### Добавление новых тегов

Через **Редактор тегов** (кнопка внизу окна):

1. Нажмите **"Редактор тегов"**
2. Нажмите **"Добавить тег"**
3. Введите:
   - **Name**: Имя тега (например, M100, Y50, X200)
   - **Address**: Адрес по формуле (см. ниже)
   - **Register**: Тип регистра
   - **Type**: Тип данных
4. Нажмите **"Сохранить"**

### Формулы расчёта адресов

Если нужного тега нет в списке, используйте формулы:

| Тег | Формула |
|-----|---------|
| X{N} | адрес = N |
| Y{N} | адрес = 1536 + N |
| M{N} | адрес = 3072 + N |
| T{N} | адрес = 15360 + N |
| C{N} | адрес = 16384 + N |
| SM{N} | адрес = 16896 + N |
| S{N} | адрес = 28672 + N |
| AI{N} | адрес = N |
| AQ{N} | адрес = 256 + N |
| V{N} | адрес = 512 + N |
| TV{N} | адрес = 15360 + N |
| CV{N} | адрес = 16384 + N |
| SV{N} | адрес = 17408 + N |

**Примеры**:
- M100 → 3072 + 100 = **3172**
- Y50 → 1536 + 50 = **1586**
- X200 → **200**

## Регенерация tags.json

Если файл `tags.json` повреждён или удалён, запустите:

```powershell
python generate_tags.py
```

Будет создан новый файл с 35421 тегом.

## Сброс к дефолтным тегам

Для перезагрузки первых 20 тегов каждого типа:

```powershell
Remove-Item "$env:APPDATA\Scada.Client\settings.json" -Force
```

Перезапустите приложение.

## Статистика тегов

В `tags.json`:
- X (Входные биты): 1024
- Y (Выходные биты): 1024
- M (Вспомогательное реле): 12288
- T (Таймеры биты): 1024
- C (Счетчики биты): 256
- SM (Системные биты): 216
- S (Пошаговое реле): 2048
- AI (Аналоговые входы): 256
- AQ (Аналоговые выходы): 256
- V (Регистры данных): 14848
- TV (Значения таймеров): 1024
- CV (Значения счетчиков): 256
- SV (Системные регистры): 901

**ВСЕГО: 35421 тег**


Файл `tags.json` содержит полное описание карты адресов PLC для приложения SCADA.

## Структура файла

### 1. Coils (Дискретные биты)

Все дискретные биты разделены на диапазоны:

#### Входные биты (X) - Только чтение
- **Диапазон**: X0 - X1023
- **Адреса**: 0 - 1023
- **Тип регистра**: DiscreteInputs
- **Доступ**: ReadOnly

**Пример**: X0 → адрес 0, X100 → адрес 100

#### Выходные биты (Y) - Чтение/Запись
- **Диапазон**: Y0 - Y1023
- **Адреса**: 1536 - 2559
- **Тип регистра**: Coils
- **Доступ**: ReadWrite

**Формула**: `адрес = 1536 + номер_бита`  
**Пример**: Y0 → адрес 1536, Y100 → адрес 1636

#### Вспомогательное реле (M) - Чтение/Запись
- **Диапазон**: M0 - M12287
- **Адреса**: 3072 - 15359
- **Тип регистра**: Coils
- **Доступ**: ReadWrite

**Формула**: `адрес = 3072 + номер_реле`  
**Пример**: M0 → адрес 3072, M1000 → адрес 4072

#### Таймеры (T) - Чтение/Запись
- **Диапазон**: T0 - T1023
- **Адреса**: 15360 - 16383
- **Тип регистра**: Coils (биты состояния)
- **Доступ**: ReadWrite

**Формула**: `адрес = 15360 + номер_таймера`  
**Пример**: T0 → адрес 15360, T100 → адрес 15460

#### Счетчики (C) - Чтение/Запись
- **Диапазон**: C0 - C255
- **Адреса**: 16384 - 16639
- **Тип регистра**: Coils (биты состояния)
- **Доступ**: ReadWrite

**Формула**: `адрес = 16384 + номер_счетчика`  
**Пример**: C0 → адрес 16384, C100 → адрес 16484

#### Системные биты (SM) - Чтение/Запись*
- **Диапазон**: SM0 - SM215
- **Адреса**: 16896 - 17111
- **Тип регистра**: Coils
- **Доступ**: ReadWrite (некоторые только чтение)

**Формула**: `адрес = 16896 + номер_бита`  
**Пример**: SM0 → адрес 16896

#### Пошаговое реле (S) - Чтение/Запись
- **Диапазон**: S0 - S2047
- **Адреса**: 28672 - 30719
- **Тип регистра**: Coils
- **Доступ**: ReadWrite

**Формула**: `адрес = 28672 + номер_реле`  
**Пример**: S0 → адрес 28672

---

### 2. Registers (16-битные и 32-битные регистры)

#### ⚠️ Параметры модуля расширения (CR) - НЕ ИСПОЛЬЗОВАТЬ!
- **Диапазон**: CR0 - CR255
- **Адреса**: 0 - 255
- **Доступ**: DoNotUse

#### Аналоговые входы (AI) - Только чтение
- **Диапазон**: AI0 - AI255
- **Адреса**: 0 - 255
- **Тип регистра**: InputRegisters
- **Тип данных**: UInt16
- **Доступ**: ReadOnly

**Формула**: `адрес = номер_входа`  
**Пример**: AI0 → адрес 0, AI100 → адрес 100

#### Аналоговые выходы (AQ) - Только чтение
- **Диапазон**: AQ0 - AQ255
- **Адреса**: 256 - 511
- **Тип регистра**: HoldingRegisters
- **Тип данных**: UInt16
- **Доступ**: ReadOnly

**Формула**: `адрес = 256 + номер_выхода`  
**Пример**: AQ0 → адрес 256, AQ100 → адрес 356

#### Внутренние регистры данных (V) - Чтение/Запись
- **Диапазон**: V0 - V14847
- **Адреса**: 512 - 15359
- **Тип регистра**: HoldingRegisters
- **Доступ**: ReadWrite

**Формула**: `адрес = 512 + номер_регистра`

**Типы данных**:
- **16-бит (1 регистр)**: Int16 (-32768 ~ +32767) или UInt16 (0 ~ 65535)
- **32-бит (2 регистра)**: Int32 (-2147483648 ~ +2147483647)
- **32-бит Float (2 регистра)**: Float32 (-3.402823e+38 ~ 3.402823e+38)

**Примеры**:
- V0 (16-бит) → адрес 512
- V0 (32-бит Int32) → адреса 512-513 (2 регистра)
- V0 (32-бит Float) → адреса 512-513 (2 регистра)
- V1000 (16-бит) → адрес 1512

#### Текущие значения таймеров (TV) - Чтение/Запись
- **Диапазон**: TV0 - TV1023
- **Адреса**: 15360 - 16383
- **Тип регистра**: HoldingRegisters
- **Тип данных**: UInt16
- **Доступ**: ReadWrite

**Формула**: `адрес = 15360 + номер_таймера`  
**Пример**: TV0 → адрес 15360, TV100 → адрес 15460

#### Текущие значения счетчиков (CV) - Чтение/Запись
- **Диапазон**: CV0 - CV255
- **Адреса**: 16384 - 16639
- **Тип регистра**: HoldingRegisters
- **Доступ**: ReadWrite

**Особенности**:
- **CV0 - CV47**: 16-бит (1 регистр)
- **CV48 - CV79**: 32-бит (2 регистра)

**Формула**: `адрес = 16384 + номер_счетчика`

**Примеры**:
- CV0 (16-бит) → адрес 16384
- CV47 (16-бит) → адрес 16431
- CV48 (32-бит) → адреса 16432-16433
- CV79 (32-бит) → адреса 16463-16464

#### Системные специальные регистры (SV) - Чтение/Запись*
- **Диапазон**: SV0 - SV900
- **Адреса**: 17408 - 18308
- **Тип регистра**: HoldingRegisters
- **Тип данных**: UInt16
- **Доступ**: ReadWrite (некоторые только чтение)

**Формула**: `адрес = 17408 + номер_регистра`  
**Пример**: SV0 → адрес 17408

---

## Использование в приложении

### Добавление тега через редактор

1. Откройте **Редактор тегов** в приложении
2. Нажмите **Добавить тег**
3. Заполните поля:
   - **Name**: Имя тега (например, "Pump1_Running")
   - **Address**: Вычислите по формуле выше (например, для Y100 → 1636)
   - **Register**: Выберите тип (Holding, Input, Coils)
   - **Type**: Тип данных (UInt16, Int32, Float32 и т.д.)
   - **Scale**: Коэффициент масштабирования (по умолчанию 1.0)
   - **Offset**: Смещение (по умолчанию 0.0)
   - **Enabled**: Включить тег

### Примеры настройки тегов

#### Пример 1: Дискретный выход Y10
```json
{
  "name": "Valve1_Open",
  "address": 1546,
  "register": "Coils",
  "type": "UInt16",
  "enabled": true
}
```
Расчет: 1536 + 10 = 1546

#### Пример 2: Аналоговый вход AI5
```json
{
  "name": "Temperature_Sensor",
  "address": 5,
  "register": "Input",
  "type": "UInt16",
  "scale": 0.1,
  "offset": -50.0,
  "enabled": true
}
```
Формула преобразования: `Температура = (RawValue * 0.1) - 50`

#### Пример 3: 32-битное целое в V100
```json
{
  "name": "Production_Counter",
  "address": 612,
  "register": "Holding",
  "type": "Int32",
  "enabled": true
}
```
Расчет: 512 + 100 = 612 (занимает адреса 612-613)

#### Пример 4: Float в V200
```json
{
  "name": "Flow_Rate",
  "address": 712,
  "register": "Holding",
  "type": "Float32",
  "scale": 1.0,
  "enabled": true
}
```
Расчет: 512 + 200 = 712 (занимает адреса 712-713)

#### Пример 5: Вспомогательное реле M500
```json
{
  "name": "System_Ready",
  "address": 3572,
  "register": "Coils",
  "type": "UInt16",
  "enabled": true
}
```
Расчет: 3072 + 500 = 3572

---

## Быстрый справочник формул

| Тег | Формула адреса | Пример |
|-----|----------------|--------|
| X | `X номер` | X100 → 100 |
| Y | `1536 + номер` | Y100 → 1636 |
| M | `3072 + номер` | M1000 → 4072 |
| T | `15360 + номер` | T50 → 15410 |
| C | `16384 + номер` | C10 → 16394 |
| SM | `16896 + номер` | SM5 → 16901 |
| S | `28672 + номер` | S100 → 28772 |
| AI | `номер` | AI25 → 25 |
| AQ | `256 + номер` | AQ10 → 266 |
| V | `512 + номер` | V1000 → 1512 |
| TV | `15360 + номер` | TV20 → 15380 |
| CV | `16384 + номер` | CV5 → 16389 |
| SV | `17408 + номер` | SV100 → 17508 |

---

## Важные замечания

1. **CR0-CR255** - НЕ ИСПОЛЬЗОВАТЬ! Зарезервировано для модулей расширения.

2. **32-битные значения** занимают 2 последовательных регистра:
   - V100 (Int32) использует регистры 612 и 613
   - V100 (Float32) использует регистры 612 и 613

3. **Счетчики CV**:
   - CV0-CV47: 16-бит (1 регистр)
   - CV48-CV79: 32-бит (2 регистра)

4. **Биты таймеров и счетчиков**:
   - T0-T1023 (адреса 15360-16383) - биты состояния (вкл/выкл)
   - TV0-TV1023 (адреса 15360-16383) - текущие значения (регистры)

5. **Системные регистры SM и SV**:
   - Не все доступны для записи
   - Перед записью проверьте документацию PLC

---

## Обновление файла tags.json

При необходимости вы можете отредактировать `tags.json` вручную или через редактор тегов в приложении. После изменений перезапустите приложение для применения новой конфигурации.
