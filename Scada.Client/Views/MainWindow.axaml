<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="using:Scada.Client.ViewModels"
    xmlns:controls="using:Scada.Client.Views.Controls"
        mc:Ignorable="d" d:DesignWidth="1920" d:DesignHeight="1080"
        x:Class="Scada.Client.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Title="SCADA - Мнемосхема"
        Width="1920" Height="1080"
        Closing="OnWindowClosing">
    
    <Grid RowDefinitions="Auto,*" Margin="10">
        <!-- Unified Top Bar - Status + Actions -->
        <Border Grid.Row="0" 
                Background="{DynamicResource AccentFillColorDefaultBrush}" 
                Padding="6" 
                CornerRadius="3" 
                Margin="0,0,0,10">
            <Grid ColumnDefinitions="*,Auto">
                <!-- Left side: Status and Connection -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                    <TextBlock Text="{Binding ConnectionStatus}" 
                               Foreground="{DynamicResource TextOnAccentFillColorPrimaryBrush}" 
                               VerticalAlignment="Center" 
                               FontSize="11"/>
                    <Button Content="Подключить" Command="{Binding ConnectCommand}" 
                            IsEnabled="{Binding !IsConnected}" Padding="8,4" FontSize="12" FontWeight="SemiBold" 
                            Height="28" VerticalContentAlignment="Center"/>
                    <Button Content="Отключить" Command="{Binding DisconnectCommand}" 
                            IsEnabled="{Binding IsConnected}" Padding="8,4" FontSize="12" FontWeight="SemiBold" 
                            Height="28" VerticalContentAlignment="Center"/>
                </StackPanel>
                
                <!-- Right side: Actions -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="6">
                    <Button Content="Добавить элемент" Click="OnAddElementButtonClick" Padding="8,4" FontSize="12" FontWeight="SemiBold" 
                            Height="28" VerticalContentAlignment="Center"/>
                    <Button Content="Редактор тегов" Command="{Binding OpenTagsEditorCommand}" Padding="8,4" FontSize="12" FontWeight="SemiBold" 
                            Height="28" VerticalContentAlignment="Center"/>
                    <Button Content="Настройки" Command="{Binding OpenSettingsCommand}" Padding="8,4" FontSize="12" FontWeight="SemiBold" 
                            Height="28" VerticalContentAlignment="Center"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Main Content - Split Toolbar and Mnemoscheme -->
        <Grid Grid.Row="1" RowDefinitions="Auto,Auto,*" RowSpacing="0">
            <!-- Toolbar Section -->
            <Border Grid.Row="0" 
                    Background="{DynamicResource CardBackgroundFillColorDefaultBrush}" 
                    BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}" 
                    BorderThickness="2,2,2,0" 
                    CornerRadius="5,5,0,0" 
                    Padding="8">
                <StackPanel Spacing="5">
                    <TextBlock Text="Панель инструментов" FontSize="12" FontWeight="SemiBold"/>
                    
                    <!-- Test Register Read -->
                    <Grid ColumnDefinitions="Auto,150,Auto,100,Auto,60" RowDefinitions="Auto,Auto">
                        <TextBlock Grid.Column="0" Text="Тег:" VerticalAlignment="Center" Margin="0,0,5,0" FontSize="11"/>
                        <ComboBox Grid.Column="1"
                                  ItemsSource="{Binding ConnectionConfig.Tags}"
                                  SelectedItem="{Binding SelectedTag}"
                                  MinWidth="120"
                                  Height="26"
                                  FontSize="11">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Name}"/>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>

                        <TextBlock Grid.Column="2" Text="Адрес:" VerticalAlignment="Center" Margin="8,0,5,0" FontSize="11"/>
                        <NumericUpDown Grid.Column="3" Value="{Binding RegisterAddress}"
                                       Minimum="0" Maximum="65535" Increment="1"
                                       Height="26"
                                       FontSize="11"/>

                        <Button Grid.Column="4" Content="Читать" Command="{Binding ReadRegisterCommand}"
                                Margin="8,0" Padding="10,3" FontSize="11" Height="26"/>
                        <TextBlock Grid.Column="5" Text="{Binding RegisterValue}"
                                   VerticalAlignment="Center" FontSize="12" FontWeight="Bold"/>
                        
                        <!-- Coil write controls -->
                        <StackPanel Grid.Row="1" Grid.ColumnSpan="6" Orientation="Horizontal" Spacing="5" Margin="0,5,0,0">
                            <TextBlock Text="Coil запись:" VerticalAlignment="Center" FontSize="11"/>
                            <Button Content="ON" Command="{Binding CoilOnCommand}" Padding="8,2" FontSize="11" Height="24"/>
                            <Button Content="OFF" Command="{Binding CoilOffCommand}" Padding="8,2" FontSize="11" Height="24"/>
                        </StackPanel>
                    </Grid>
                </StackPanel>
            </Border>
            
            <!-- Separator line - яркая полоса разделителя -->
            <Rectangle Grid.Row="1" 
                       Fill="#2196F3" 
                       Height="1"
                       Margin="0,0,0,10"/>

            <!-- Mnemoscheme Canvas Section -->
            <Border Grid.Row="2" 
                    BorderBrush="{DynamicResource CardStrokeColorDefaultBrush}" 
                    BorderThickness="2" 
                    CornerRadius="5" 
                    Background="{DynamicResource SolidBackgroundFillColorBaseBrush}">
                <Grid>
                    <Canvas x:Name="MnemoCanvas" 
                            Background="{DynamicResource LayerFillColorDefaultBrush}" 
                            ClipToBounds="True">
                    
                    <!-- Pump Control -->
                    <controls:DraggableControl X="50" Y="50">
                        <controls:PumpControl Label="Насос 1"
                                              IsRunning="{Binding Pump1Running}"
                                              HasAlarm="{Binding Pump1Alarm}"/>
                    </controls:DraggableControl>

                    <!-- Valve Control -->
                    <controls:DraggableControl X="300" Y="50">
                        <controls:ValveControl Label="Клапан 1"
                                                OpenPercent="{Binding Valve1OpenPercent}"
                                                HasAlarm="False"/>
                    </controls:DraggableControl>

                    <!-- Sensor Indicator -->
                    <controls:DraggableControl X="550" Y="50">
                        <controls:SensorIndicator Label="Давление"
                                                  Value="{Binding Sensor1Value}"
                                                  Unit="бар"
                                                  ThresholdLow="1.0"
                                                  ThresholdHigh="8.0"/>
                    </controls:DraggableControl>

                    <!-- CoilButton 1 -->
                    <controls:DraggableControl X="50" Y="200">
                        <controls:CoilButton Label="Кнопка 0"
                                            IsActive="{Binding Coil1Active}"
                                            CoilAddress="{Binding Coil1Address, Mode=TwoWay}"
                                            AvailableTags="{Binding ConnectionConfig.Tags}"
                                            OnCommand="{Binding Coil1OnCommand}"
                                            OffCommand="{Binding Coil1OffCommand}"/>
                    </controls:DraggableControl>

                    <!-- CoilButton 2 -->
                    <controls:DraggableControl X="300" Y="200">
                        <controls:CoilButton Label="Кнопка 1"
                                            IsActive="{Binding Coil2Active}"
                                            CoilAddress="{Binding Coil2Address, Mode=TwoWay}"
                                            AvailableTags="{Binding ConnectionConfig.Tags}"
                                            OnCommand="{Binding Coil2OnCommand}"
                                            OffCommand="{Binding Coil2OffCommand}"/>
                    </controls:DraggableControl>

                    <!-- CoilButton 3 -->
                    <controls:DraggableControl X="550" Y="200">
                        <controls:CoilButton Label="Кнопка 2"
                                            IsActive="{Binding Coil3Active}"
                                            CoilAddress="{Binding Coil3Address, Mode=TwoWay}"
                                            AvailableTags="{Binding ConnectionConfig.Tags}"
                                            OnCommand="{Binding Coil3OnCommand}"
                                            OffCommand="{Binding Coil3OffCommand}"/>
                    </controls:DraggableControl>

                    <!-- ImageButton Motor -->
                    <controls:DraggableControl X="50" Y="320">
                        <controls:ImageButton Label="Мотор"
                                             ImageType="Motor"
                                             IsActive="{Binding MotorActive}"
                                             CoilAddress="{Binding MotorAddress, Mode=TwoWay}"
                                             AvailableTags="{Binding ConnectionConfig.Tags}"
                                             OnCommand="{Binding MotorOnCommand}"
                                             OffCommand="{Binding MotorOffCommand}"/>
                    </controls:DraggableControl>

                    <!-- ImageButton Valve -->
                    <controls:DraggableControl X="300" Y="320">
                        <controls:ImageButton Label="Клапан"
                                             ImageType="Valve"
                                             IsActive="{Binding ValveActive}"
                                             CoilAddress="{Binding ValveAddress, Mode=TwoWay}"
                                             AvailableTags="{Binding ConnectionConfig.Tags}"
                                             OnCommand="{Binding ValveOnCommand}"
                                             OffCommand="{Binding ValveOffCommand}"/>
                    </controls:DraggableControl>

                    <!-- ImageButton Fan -->
                    <controls:DraggableControl X="550" Y="320">
                        <controls:ImageButton Label="Вентилятор"
                                             ImageType="Fan"
                                             IsActive="{Binding FanActive}"
                                             CoilAddress="{Binding FanAddress, Mode=TwoWay}"
                                             AvailableTags="{Binding ConnectionConfig.Tags}"
                                             OnCommand="{Binding FanOnCommand}"
                                             OffCommand="{Binding FanOffCommand}"/>
                    </controls:DraggableControl>

                    <!-- CoilReadButton -->
                    <controls:DraggableControl X="50" Y="440">
                        <controls:CoilReadButton Label="Чтение катушки"
                                                CoilAddress="{Binding ReadCoilAddress, Mode=TwoWay}"
                                                CoilValue="{Binding ReadCoilValue}"
                                                AvailableTags="{Binding ConnectionConfig.Tags}"
                                                ReadCommand="{Binding ReadCoilCommand}"/>
                    </controls:DraggableControl>

                    <!-- CoilButton в режиме Momentary (кнопка без фиксации) -->
                    <controls:DraggableControl X="300" Y="440">
                        <controls:CoilButton Label="Кнопка (момент.)"
                                            IsActive="{Binding MomentaryActive}"
                                            CoilAddress="{Binding MomentaryAddress, Mode=TwoWay}"
                                            ButtonType="Momentary"
                                            AvailableTags="{Binding ConnectionConfig.Tags}"
                                            OnCommand="{Binding MomentaryOnCommand}"
                                            OffCommand="{Binding MomentaryOffCommand}"/>
                    </controls:DraggableControl>

                </Canvas>
                
                    <!-- Прозрачный оверлей для перехвата правого клика (НЕ блокирует события дочерних элементов) -->
                    <Border x:Name="CanvasOverlay" 
                            Background="Transparent"
                            IsHitTestVisible="False"/>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</Window>
